---
title: "Data Wrangling"
author: "KO"
date: "11/29/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r warning=FALSE, message=FALSE}
library(readr)
library(dplyr)

data <- read_delim('revent.TXT', delim = ";")
# head(data)
# ncol(data)

# data <- sapply(data[18:203], function(x) as.numeric(as.character(x)))

dataFinal <- data %>%
  
  # Filtering for PGA TOUR Stroke Play Events
  
  filter(`Official Event(Y/N)` == "Y") %>%
  
  # Changing variables to the proper types
  
  mutate(`Total Rounds` = as.numeric(`Total Rounds)`),
         `Finish Position(numeric)` = as.numeric(`Finish Position(numeric)`),
         `Birdies` = as.numeric(`Birdies`),
         `Total Holes Over Par` = as.numeric(`Total Holes Over Par`),
         `Drives Over 300 Yards (# of Drives)` = as.numeric(`Drives Over 300 Yards (# of Drives)`),
         `3-Putt Avoid(Total 3 Putts)` = as.numeric(`3-Putt Avoid(Total 3 Putts)`),
         `Avg Distance of Putts Made(Total Distance of Putts)` = as.numeric(`Avg Distance of Putts Made(Total Distance of Putts)`),
         `Total Holes Played` = as.numeric(`Total Holes Played`),
         `Total Greens in Regulation` = as.numeric(`Total Greens in Regulation`),
         `App. 50-125 Yards(ft)` = as.numeric(`App. 50-125 Yards(ft)`),
         `App.  50-125 Yards(attempts)` = as.numeric(`App.  50-125 Yards(attempts)`),
         
         #Creating our desired variables
         
         cutMade = as.factor(ifelse(`Finish Position(numeric)` < 999, 1, 0)),
         birdiesPerRound = `Birdies` / `Total Rounds`,
         GIRsPerRound = `Total Greens in Regulation` / `Total Holes Played`,
         overParHolesPerRound = `Total Holes Over Par` / `Total Rounds`,
         ThreePuttsPerRound = `3-Putt Avoid(Total 3 Putts)` / `Total Rounds`,
         over300DrivesPerRound = `Drives Over 300 Yards (# of Drives)` /
           `Total Rounds`,
         distPuttsMadePerRound = `Avg Distance of Putts Made(Total Distance of Putts)` / `Total Rounds`,
         proxToHoleApproach = `App. 50-125 Yards(ft)` / `App.  50-125 Yards(attempts)`)  %>%

  #Selecting our desired columns
  
  select(`Player Name`,
        `Event Name`,
        cutMade,
        birdiesPerRound,
        GIRsPerRound,
        overParHolesPerRound,
        ThreePuttsPerRound,
        over300DrivesPerRound,
        distPuttsMadePerRound,
        proxToHoleApproach)

# https://stackoverflow.com/questions/4862178/remove-rows-with-all-or-some-nas-missing-values-in-data-frame 
dataFinal <- dataFinal[complete.cases(dataFinal), ]

head(dataFinal)
#View(dataFinal)
```

```{r}
# Random Forest

library(rpart)
library(partykit)
library(randomForest)
library(pROC)
# ?randomForest

##############
# split 80/20 --------------------------
set.seed(123)

n <- nrow(dataFinal)
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train1 <- dataFinal[train_id,] # the data set we'll train the model on
test1 <- dataFinal[-train_id,] # the data set we'll test the model on

head(train1)
head(test1)
```

```{r}
# Setting formula for random forest
f <- as.formula(cutMade ~ birdiesPerRound + GIRsPerRound + overParHolesPerRound + ThreePuttsPerRound + over300DrivesPerRound + distPuttsMadePerRound + proxToHoleApproach)

# Training forest
mod_forest <- randomForest(f, data = train1, ntree = 128, mtry = 2)
mod_forest

sum(diag(mod_forest$confusion)) / nrow(train1)

# Get importance, code from textbook
library(tibble)
importance(mod_forest) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(MeanDecreaseGini))
 
# https://www.r-bloggers.com/how-to-implement-random-forests-in-r/ 
predTest <- predict(mod_forest, test1, type = "class")

mean(predTest == test1$cutMade)
table(predTest,test1$cutMade)

# predict on test and evaluate the model on test using auc-----------------------
# head(predTest)
# ?predict
pred_AUC <- predict(mod_forest, test1, type = "prob")[,1]

test1 <- test1 %>% mutate(prediction = pred_AUC)

roc_obj <- roc(test1$cutMade, test1$prediction)
auc(roc_obj)
plot(roc_obj)
#summary(roc_obj)
```

```{r}
# Setting formula for random forest 2
f2 <- as.formula(cutMade ~ GIRsPerRound + ThreePuttsPerRound + over300DrivesPerRound + distPuttsMadePerRound + proxToHoleApproach)

# Training forest 2
mod_forest2 <- randomForest(f2, data = train1, ntree = 128, mtry = 2)
mod_forest2

sum(diag(mod_forest2$confusion)) / nrow(train1)

# Get importance, code from textbook
library(tibble)
importance(mod_forest2) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(MeanDecreaseGini))
 
# https://www.r-bloggers.com/how-to-implement-random-forests-in-r/ 
predTest2 <- predict(mod_forest2, test1, type = "cls")

mean(predTest2 == test1$cutMade)
table(predTest2, test1$cutMade)

# predict on test and evaluate the model on test using auc-----------------------
# head(predTest2)
# ?predict
pred_AUC2 <- predict(mod_forest2, test1, type = "prob")[,1]

test1 <- test1 %>% mutate(prediction2 = pred_AUC2)

roc_obj <- roc(test1$cutMade, test1$prediction2)
auc(roc_obj)
plot(roc_obj)
#summary(roc_obj)

# Variable Importance Plot
varImpPlot(mod_forest2, main = "Variable Importance")
```














Below this is all old code.

```{r}
# Neural Network 1

library(rpart)
library(partykit)

# Scale numeric data between 0 and 1
scale_0_1 <- function(x) {
  #' param x a numeric column that will be scaled 
  rng <- range(x, na.rm = TRUE)
  (x - rng[1]) / (rng[2] - rng[1])
}

scaledData <- data.frame(lapply(dataFinal, FUN=function(x) if (is.numeric(x)) scale_0_1(x) else x))

##############
# split 80/20 --------------------------
set.seed(123)

n <- nrow(scaledData)
train_id <- sample(1:n, size=round(n*0.8)) # select approx 80% of the row numbers between 1 and n
train <- scaledData[train_id,] # the data set we'll train the model on
test <- scaledData[-train_id,] # the data set we'll test the model on

head(train)
head(test)

# train a nueral network classifier using the same train data as above.
library(nnet)

f <- as.formula(cutMade ~ birdiesPerRound + GIRsPerRound + overParHolesPerRound + ThreePuttsPerRound)

train <- train %>%
  mutate(cutMade = as.integer(cutMade))

neuralNetwork <- nnet(f, data=train, size=3)
```

```{r}
# load library
library(neuralnet)

# fit neural network
set.seed(2)
NN <- neuralnet(f, train, hidden = 1, linear.output = T)

# plot neural network
plot(NN)
```


```{r}
# predict on test and evaluate the model on test using auc-----------------------
library(pROC)
pred <- predict(neuralNetwork, test, type = "raw")[,1] # a vector of probabilities
test <- test %>% mutate(prediction = pred)

roc_obj <- roc(test$cutMade, test$prediction)
auc(roc_obj)
plot(roc_obj)
#summary(roc_obj)
```
